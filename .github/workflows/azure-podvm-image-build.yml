name: azure-podvm-image-build

on:
  workflow_call:
    inputs:
      image-version:
        type: string
        required: true
      image-variant:
        type: string
        default: production
      image-gallery:
        type: string
      image-definition:
        type: string
      community-gallery-name:
        type: string
      resource-group:
        type: string
      git-ref:
        type: string
        default: 'main'
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
    outputs:
      image-id:
        description: "The PodVM image id"
        value: ${{ jobs.build-podvm-image.outputs.image-id }}

  workflow_dispatch:
    inputs:
      image-version:
        type: string
        description: x.y.z
        required: true
      image-variant:
        type: string
        default: production
        description: image variant
      git-ref:
        type: string
        default: 'main'
        description: tag, branch, sha

permissions: {}

jobs:
  build-podvm-image:
    runs-on: ubuntu-24.04
    defaults:
      run:
        working-directory: cloud-api-adaptor/src/cloud-api-adaptor/podvm-mkosi
    outputs:
      image-id: "${{ steps.upload-image.outputs.image-id }}"
    permissions:
      id-token: write
      contents: read
      packages: write
      attestations: write
    steps:
    - name: Clone cloud-api-adaptor repository
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        path: cloud-api-adaptor
        ref: ${{ inputs.git-ref }}
        persist-credentials: false

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-utils swtpm qemu-system-x86
        sudo snap install yq

    - name: Read properties from versions.yaml
      run: |
        echo "MKOSI_VERSION=$(yq -e '.tools.mkosi' ../versions.yaml)" >> "$GITHUB_ENV"

    - name: Install uplosi
      env:
        UPLOSI_VERSION: "0.3.0"
        UPLOSI_SHA256: "687bcab7398ab0fda65a3809492e8cd4d6a25aad1573927be5ec75ac1c4cbc35"
      run: |
        wget -q "https://github.com/edgelesssys/uplosi/releases/download/v${UPLOSI_VERSION}/uplosi_${UPLOSI_VERSION}_linux_amd64.tar.gz"
        sha256sum -c <(echo "$UPLOSI_SHA256"  "uplosi_${UPLOSI_VERSION}_linux_amd64.tar.gz")
        tar xzf uplosi_0.3.0_linux_amd64.tar.gz uplosi
        sudo mv uplosi /usr/local/bin

    - name: Build binaries
      env:
        TEE_PLATFORM: az-cvm-vtpm
        VERIFY_PROVENANCE: yes
      run: |
        make binaries

    - name: Build image
      if: inputs.image-variant == 'production'
      run: make image

    - name: Build debug image
      if: inputs.image-variant != 'production'
      run: make image-debug

    - uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3.0
      name: 'Az CLI login'
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}

    - name: upload image
      id: upload-image
      env:
        SUBSCRIPTION_ID: "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
        IMAGE_VERSION: "${{ inputs.image-version }}"
        RESOURCE_GROUP: "${{ inputs.resource-group || vars.AZURE_RESOURCE_GROUP }}"
        IMAGE_GALLERY: "${{ inputs.image-gallery || vars.AZURE_PODVM_GALLERY_NAME }}"
        IMAGE_DEFINITION: "${{ inputs.image-definition || vars.AZURE_PODVM_IMAGE_DEF_NAME }}"
        COMMUNITY_GALLERY_NAME: "${{ inputs.community-gallery-name || vars.AZURE_COMMUNITY_GALLERY_NAME }}"
      run: |
        IMAGE_ID="/CommunityGalleries/${COMMUNITY_GALLERY_NAME}/Images/${IMAGE_DEFINITION}/Versions/${IMAGE_VERSION}"
        SHARING_NAME_PREFIX="$(echo "$COMMUNITY_GALLERY_NAME" | cut -d'-' -f1)"
        cat <<EOF> uplosi.conf
        [base]
        imageVersion = "$IMAGE_VERSION"
        name         = "$IMAGE_DEFINITION"

        [base.azure]
        subscriptionID     = "$SUBSCRIPTION_ID"
        location           = "eastus"
        resourceGroup      = "$RESOURCE_GROUP"
        sharedImageGallery = "$IMAGE_GALLERY"
        sharingNamePrefix  = "$SHARING_NAME_PREFIX"

        [variant.default]
        provider = "azure"

        [variant.default.azure]
        replicationRegions = ["eastus","eastus2","westeurope","northeurope"]
        EOF

        uplosi upload build/system.raw
        echo "successfully built $IMAGE_ID"
        echo "image-id=${IMAGE_ID}" >> "$GITHUB_OUTPUT"

    - uses: oras-project/setup-oras@22ce207df3b08e061f537244349aac6ae1d214f6 # v1.2.4
      with:
        version: 1.2.0

    - name: Scrape PodVM measurements
      run: |
        wget -q http://security.debian.org/debian-security/pool/updates/main/e/edk2/ovmf_2022.11-6+deb12u1_all.deb
        mkdir -p ovmf-pkg
        dpkg-deb -x ovmf_2022.11-6+deb12u1_all.deb ovmf-pkg/
        cp ovmf-pkg/usr/share/OVMF/OVMF_CODE.fd .
        ../hack/podvm-measure.sh swtpm &
        sudo ../hack/podvm-measure.sh -i build/system.raw launch &
        ../hack/podvm-measure.sh wait
        ../hack/podvm-measure.sh scrape > measurements.json
        ../hack/podvm-measure.sh stop
        # verify json
        jq -e . measurements.json

    - uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Publish measurements
      if: inputs.image-variant == 'production'
      id: publish-measurements
      env:
        OCI_NAME: ghcr.io/${{ github.repository }}/measurements/azure/podvm
        OCI_TAG: ${{ inputs.image-version }}
      run: |
        oras push "${OCI_NAME}:${OCI_TAG}" measurements.json
        OCI_DIGEST=$(oras resolve "${OCI_NAME}:${OCI_TAG}")
        echo "oci-name=${OCI_NAME}" >> "$GITHUB_OUTPUT"
        echo "oci-digest=${OCI_DIGEST}" >> "$GITHUB_OUTPUT"

    - uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
      if: inputs.image-variant == 'production'
      with:
        subject-name: ${{ steps.publish-measurements.outputs.oci-name }}
        subject-digest: ${{ steps.publish-measurements.outputs.oci-digest }}
        push-to-registry: true
