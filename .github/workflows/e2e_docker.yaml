# (C) Copyright Confidential Containers Contributors 2024.
# SPDX-License-Identifier: Apache-2.0
#
# Run docker e2e tests.
name: (Callable) docker e2e tests

on:
  workflow_call:
    inputs:
      podvm_image:
        required: true
        type: string
      caa_image:
        description: The cloud-api-adaptor OCI image (including tag) to test
        type: string
      install_directory_artifact:
        description: The archive name of the install directory
        default: ''
        required: false
        type: string
      git_ref:
        default: 'main'
        description: Git ref to checkout the cloud-api-adaptor repository. Defaults to main.
        required: false
        type: string
      container_runtime:
        default: 'containerd'
        description: Name of the container runtime. Either containerd or crio.
        required: false
        type: string
      install_method:
        default: 'kustomize'
        description: Installation method. Either kustomize or helm.
        required: false
        type: string
    secrets:
      QUAY_PASSWORD:
        required: true

env:
  CLOUD_PROVIDER: docker
  CLUSTER_NAME: peer-pods
  DEBIAN_FRONTEND: noninteractive

defaults:
  run:
    working-directory: src/cloud-api-adaptor

permissions: {}

jobs:
  test-docker:
    name: "Docker e2e tests: (${{ inputs.container_runtime }}, ${{ inputs.install_method }})"
    runs-on: ubuntu-22.04
    # TODO: remove when helm installation gets implemented and stable.
    continue-on-error: ${{ inputs.install_method == 'helm' }}
    env:
      INSTALL_METHOD: "${{ inputs.install_method }}"
      CAA_IMAGE: "${{ inputs.caa_image }}"
    steps:
      - name: Checkout Code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          ref: ${{ inputs.git_ref }}
          persist-credentials: false

      - name: Rebase the code
        if: github.event_name == 'pull_request_target'
        working-directory: ./
        run: |
          ./hack/ci-helper.sh rebase-atop-of-the-latest-target-branch

      - name: Remove unnecessary directories to free up space
        working-directory: ./
        run: |
          sudo ./hack/ci-helper.sh clean-up-runner

      - name: Login to quay Container Registry
        if: ${{ startsWith(inputs.podvm_image, 'quay.io') }}
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: quay.io
          username: ${{ vars.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Login to the ghcr Container registry
        if: ${{ startsWith(inputs.podvm_image, 'ghcr.io') }}
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Read properties from versions.yaml
        run: |
          sudo snap install yq
          go_version="$(yq '.tools.golang' versions.yaml)"
          [ -n "$go_version" ]
          {
            echo "GO_VERSION=${go_version}"
            echo "HELM_VERSION=$(yq -e '.tools.helm.version' versions.yaml)"
            echo "HELM_CHECKSUM=$(yq -e '.tools.helm.sha256' versions.yaml)"
          } >> "$GITHUB_ENV"

      - name: Setup Golang version ${{ env.GO_VERSION }}
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install kustomize
        run: |
          command -v kustomize >/dev/null || \
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | \
            sudo bash -s /usr/local/bin

      - name: Update kustomization configuration
        if: ${{ inputs.install_method == 'kustomize' }}
        run: |
          cd "install/overlays/docker"
          kustomize edit set image "cloud-api-adaptor=${{ inputs.caa_image }}"
          # Print for debugging
          echo "::group::docker kustomization"
          cat kustomization.yaml
          echo "::endgroup::"

      - name: Install Helm
        if: ${{ inputs.install_method == 'helm' }}
        run: |
          curl -fsSL -o helm.tar.gz "https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz"
          echo "${HELM_CHECKSUM}  helm.tar.gz" | sha256sum --check --strict
          tar -xzf helm.tar.gz
          sudo mv linux-amd64/helm /usr/local/bin/helm
          rm -rf helm.tar.gz linux-amd64
          helm version

      - name: Config docker
        run: |
          cat <<- EOF > docker.properties
          DOCKER_PODVM_IMAGE="${{ inputs.podvm_image }}"
          DOCKER_HOST="unix:///var/run/docker.sock"
          DOCKER_NETWORK_NAME="kind"
          CONTAINER_RUNTIME="${{ inputs.container_runtime }}"
          DOCKER_API_VERSION="1.44"
          EOF

          # For debugging
          echo "::group::docker.properties"
          cat docker.properties
          echo "::endgroup::"

      - name: Create helm values file
        if: ${{ inputs.install_method == 'helm' }}
        env:
          DOCKER_PODVM_IMAGE: ${{ inputs.podvm_image }}
        run: |
          CAA_IMAGE_TAG="${CAA_IMAGE##*:}"
          CAA_IMAGE_NAME="${CAA_IMAGE%:*}"
          cat <<EOF > helm-values.yaml
          image:
            name: "${CAA_IMAGE_NAME}"
            tag: "${CAA_IMAGE_TAG}"
          providerConfigs:
            docker:
              DOCKER_HOST: "unix:///var/run/docker.sock"
              DOCKER_NETWORK_NAME: "kind"
              DOCKER_API_VERSION: "1.44"
              DOCKER_PODVM_IMAGE: "${DOCKER_PODVM_IMAGE}"
          EOF

          echo "HELM_VALUES_FILES=install/charts/peerpods/providers/docker.yaml,$PWD/helm-values.yaml" >> "$GITHUB_ENV"

          # For debugging
          echo "::group::helm-values.yaml"
          cat helm-values.yaml
          echo "::endgroup::"

      - name: run tests
        id: runTests
        run: |
          export CLOUD_PROVIDER=docker
          export CONTAINER_RUNTIME="${{ inputs.container_runtime }}"
          export DEPLOY_KBS=false
          export TEST_PROVISION=yes
          export TEST_TEARDOWN=no
          export TEST_PROVISION_FILE="$PWD/docker.properties"
          export TEST_PODVM_IMAGE="${{ inputs.podvm_image }}"
          export TEST_E2E_TIMEOUT="50m"

          make test-e2e

      - name: Debug tests failure
        if: failure() && steps.runTests.outcome == 'failure'
        working-directory: ./
        run: |
          export KUBECONFIG="${HOME}/kube_${CLUSTER_NAME}"
          kind get kubeconfig -n "$CLUSTER_NAME" > "$KUBECONFIG"
          ./hack/ci-e2e-debug-fail.sh
        # Avoid running with `set -e` as command fails should be allowed
        shell: bash {0}
