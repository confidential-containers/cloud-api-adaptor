# (C) Copyright Confidential Containers Contributors 2024.
# SPDX-License-Identifier: Apache-2.0
#
# Run docker e2e tests.
name: (Callable) docker e2e tests

on:
  workflow_call:
    inputs:
      podvm_image:
        required: true
        type: string
      caa_image:
        description: The cloud-api-adaptor OCI image (including tag) to test
        type: string
      install_directory_artifact:
        description: The archive name of the install directory
        default: ''
        required: false
        type: string
      git_ref:
        default: 'main'
        description: Git ref to checkout the cloud-api-adaptor repository. Defaults to main.
        required: false
        type: string
      container_runtime:
        default: 'containerd'
        description: Name of the container runtime. Either containerd or crio.
        required: false
        type: string
    secrets:
      QUAY_PASSWORD:
        required: true

env:
  CLOUD_PROVIDER: docker
  CLUSTER_NAME: peer-pods
  DEBIAN_FRONTEND: noninteractive

defaults:
  run:
    working-directory: src/cloud-api-adaptor

permissions: {}

jobs:
  test-docker:
    name: "Docker e2e tests: (${{ inputs.container_runtime }})"
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          ref: ${{ inputs.git_ref }}
          persist-credentials: false

      - name: Rebase the code
        if: github.event_name == 'pull_request_target'
        working-directory: ./
        run: |
          ./hack/ci-helper.sh rebase-atop-of-the-latest-target-branch

      - name: Remove unnecessary directories to free up space
        working-directory: ./
        run: |
          sudo ./hack/ci-helper.sh clean-up-runner

      - name: Login to quay Container Registry
        if: ${{ startsWith(inputs.podvm_image, 'quay.io') }}
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: quay.io
          username: ${{ vars.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Login to the ghcr Container registry
        if: ${{ startsWith(inputs.podvm_image, 'ghcr.io') }}
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Read properties from versions.yaml
        run: |
          sudo snap install yq
          go_version="$(yq '.tools.golang' versions.yaml)"
          [ -n "$go_version" ]
          echo "GO_VERSION=${go_version}" >> "$GITHUB_ENV"

      - name: Setup Golang version ${{ env.GO_VERSION }}
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install kustomize
        run: |
          command -v kustomize >/dev/null || \
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | \
            sudo bash -s /usr/local/bin

      - name: Update kustomization configuration
        run: |
          cd "install/overlays/docker"
          kustomize edit set image "cloud-api-adaptor=${{ inputs.caa_image }}"
          # Print for debugging
          echo "::group::docker kustomization"
          cat kustomization.yaml
          echo "::endgroup::"

      - name: Config docker
        run: |
          cat <<- EOF > docker.properties
          DOCKER_PODVM_IMAGE="${{ inputs.podvm_image }}"
          DOCKER_HOST="unix:///var/run/docker.sock"
          DOCKER_NETWORK_NAME="kind"
          CONTAINER_RUNTIME="${{ inputs.container_runtime }}"
          DOCKER_API_VERSION="1.44"
          EOF
          # For debugging
          cat docker.properties

      - name: run tests
        id: runTests
        run: |
          export CLOUD_PROVIDER=docker
          export CONTAINER_RUNTIME="${{ inputs.container_runtime }}"
          export DEPLOY_KBS=false
          export TEST_PROVISION=yes
          export TEST_TEARDOWN=no
          export TEST_PROVISION_FILE="$PWD/docker.properties"
          export TEST_PODVM_IMAGE="${{ inputs.podvm_image }}"
          export TEST_E2E_TIMEOUT="50m"

          make test-e2e

      - name: Debug tests failure
        if: failure() && steps.runTests.outcome == 'failure'
        working-directory: ./
        run: |
          export KUBECONFIG="${HOME}/kube_${CLUSTER_NAME}"
          kind get kubeconfig -n "$CLUSTER_NAME" > "$KUBECONFIG"
          ./hack/ci-e2e-debug-fail.sh
        # Avoid running with `set -e` as command fails should be allowed
        shell: bash {0}
