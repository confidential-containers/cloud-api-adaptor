# This template creates K8s Secrets when secrets.mode is "create".
# For production, use secrets.mode: "reference" to reference pre-existing secrets
# managed externally (kubectl, Vault, External Secrets Operator, etc.).

{{- if eq .Values.secrets.mode "create" }}
{{- $secrets := dict }}
{{- if .Values.providerSecrets }}
{{- $secrets = index .Values.providerSecrets .Values.provider | default dict }}
{{- end }}

{{- if eq .Values.provider "libvirt" }}
{{- if or (index $secrets "id_rsa") (index $secrets "id_rsa.pub") }}
---
apiVersion: v1
kind: Secret
metadata:
  name: ssh-key-secret
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: peerpods
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
stringData:
{{- if index $secrets "id_rsa.pub" }}
  id_rsa.pub: |
{{ index $secrets "id_rsa.pub" | indent 4 }}
{{- end }}
{{- if index $secrets "id_rsa" }}
  id_rsa: |
{{ index $secrets "id_rsa" | indent 4 }}
{{- end }}
{{- end }}
{{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: peer-pods-secret
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: peerpods
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
stringData:
{{- range $key, $value := $secrets }}
  {{- if and (ne $key "id_rsa") (ne $key "id_rsa.pub") }}
  {{ $key }}: "{{ $value }}"
  {{- end }}
{{- end }}
{{- end }}
