# This template creates K8s Secrets when secrets.mode is "create".
# For production, use secrets.mode: "reference" to reference pre-existing secrets
# managed externally (kubectl, Vault, External Secrets Operator, etc.).

{{- if eq .Values.secrets.mode "create" }}
{{- $secrets := dict }}
{{- if .Values.providerSecrets }}
{{- $secrets = index .Values.providerSecrets .Values.provider | default dict }}
{{- end }}

# TODO: Provider-specific secrets like this libvirt SSH key should ideally be in
# separate files to avoid bloat. See daemonset.yaml for the same concern.
#
# ssh-key-secret (libvirt only):
# SSH private key for CAA to connect to the libvirt hypervisor via qemu+ssh://.
# This is NOT for connecting to the pod VM. Mounted to /root/.ssh/, consumed by
# libvirt C library (not Go code).
{{- if eq .Values.provider "libvirt" }}
{{- if index $secrets "id_rsa" }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "peerpods.sshKeySecretName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: peerpods
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
stringData:
  id_rsa: |
{{ index $secrets "id_rsa" | indent 4 }}
{{- end }}
{{- end }}
# peer-pods-secret (all providers):
# Cloud provider credentials (e.g., AZURE_CLIENT_ID, AWS_ACCESS_KEY_ID).
# Injected as environment variables into the CAA container.
---
apiVersion: v1
kind: Secret
metadata:
  name: peer-pods-secret
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: peerpods
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
stringData:
{{- range $key, $value := $secrets }}
  {{- if ne $key "id_rsa" }}
  {{ $key }}: "{{ $value }}"
  {{- end }}
{{- end }}

{{- if or .Values.secrets.tlsCerts.caCert .Values.secrets.tlsCerts.clientCert .Values.secrets.tlsCerts.clientKey }}
# certs-for-tls (all providers):
# Custom TLS certificates for CAA-to-peer-pod communication.
# Only created when certificate files are provided via secrets.tlsCerts.
# Mounted at /etc/certificates in the CAA container.
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "peerpods.tlsSecretName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: peerpods
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
stringData:
  {{- if .Values.secrets.tlsCerts.caCert }}
  ca.crt: |
{{ .Values.secrets.tlsCerts.caCert | indent 4 }}
  {{- end }}
  {{- if .Values.secrets.tlsCerts.clientCert }}
  client.crt: |
{{ .Values.secrets.tlsCerts.clientCert | indent 4 }}
  {{- end }}
  {{- if .Values.secrets.tlsCerts.clientKey }}
  client.key: |
{{ .Values.secrets.tlsCerts.clientKey | indent 4 }}
  {{- end }}
{{- end }}
{{- end }}
