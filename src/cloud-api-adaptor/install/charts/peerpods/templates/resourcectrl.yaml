{{- if .Values.resourceCtrl.enabled }}
# Webhook installer (peerpod-ctrl now installed via subchart)
#
# TODO: This pre-install hook should be avoided!
#
# Using Helm pre-install hook to fetch and install webhook from CAA GitHub
# repository using kustomize, mirroring what `kubectl apply -k` would do.
#
# This approach is used temporarily to avoid duplicating YAML files while we
# determine the best long-term solution with the CAA project.
#
# NOTE: Webhook requires cert-manager to be installed in the cluster.

# RBAC for installer Job
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Release.Name }}-peerpods-installer
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: peerpods
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: installer
    app.kubernetes.io/managed-by: {{ .Release.Service }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ .Release.Name }}-peerpods-installer
  labels:
    app.kubernetes.io/name: peerpods
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: installer
    app.kubernetes.io/managed-by: {{ .Release.Service }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
rules:
# CRDs
- apiGroups:
  - apiextensions.k8s.io
  resources:
  - customresourcedefinitions
  verbs:
  - get
  - list
  - create
  - update
  - patch
# ClusterRoles and ClusterRoleBindings
- apiGroups:
  - rbac.authorization.k8s.io
  resources:
  - clusterroles
  - clusterrolebindings
  verbs:
  - get
  - list
  - create
  - update
  - patch
# Roles and RoleBindings (in any namespace)
- apiGroups:
  - rbac.authorization.k8s.io
  resources:
  - roles
  - rolebindings
  verbs:
  - get
  - list
  - create
  - update
  - patch
# Pods (required to create webhook's manager-role ClusterRole due to RBAC escalation prevention)
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
# ServiceAccounts, Deployments, and Services
- apiGroups:
  - ""
  resources:
  - serviceaccounts
  - services
  verbs:
  - get
  - list
  - create
  - update
  - patch
- apiGroups:
  - apps
  resources:
  - deployments
  verbs:
  - get
  - list
  - create
  - update
  - patch
# Namespaces (to create/patch controller namespaces)
- apiGroups:
  - ""
  resources:
  - namespaces
  verbs:
  - get
  - list
  - create
  - update
  - patch
# ConfigMaps, Secrets, Events (needed by peerpod-ctrl roles)
- apiGroups:
  - ""
  resources:
  - configmaps
  - secrets
  - events
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
# Leases for leader election
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
# PeerPods CRD resources
- apiGroups:
  - confidentialcontainers.org
  resources:
  - peerpods
  - peerpods/finalizers
  - peerpods/status
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
# TokenReviews and SubjectAccessReviews (for kube-rbac-proxy)
- apiGroups:
  - authentication.k8s.io
  resources:
  - tokenreviews
  verbs:
  - create
- apiGroups:
  - authorization.k8s.io
  resources:
  - subjectaccessreviews
  verbs:
  - create
# cert-manager resources (for webhook certificates)
- apiGroups:
  - cert-manager.io
  resources:
  - certificates
  - issuers
  verbs:
  - get
  - list
  - create
  - update
  - patch
# MutatingWebhookConfiguration (for webhook)
- apiGroups:
  - admissionregistration.k8s.io
  resources:
  - mutatingwebhookconfigurations
  verbs:
  - get
  - list
  - create
  - update
  - patch
# Metrics endpoint
- nonResourceURLs:
  - /metrics
  verbs:
  - get
# OpenAPI schema access (required for kubectl apply validation)
- nonResourceURLs:
  - /openapi
  - /openapi/*
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ .Release.Name }}-peerpods-installer
  labels:
    app.kubernetes.io/name: peerpods
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: installer
    app.kubernetes.io/managed-by: {{ .Release.Service }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ .Release.Name }}-peerpods-installer
subjects:
- kind: ServiceAccount
  name: {{ .Release.Name }}-peerpods-installer
  namespace: {{ .Values.namespace }}
---
# Installer Job
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-resourcectrl-install
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: peerpods
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: installer
    app.kubernetes.io/managed-by: {{ .Release.Service }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: peerpods
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: installer
    spec:
      restartPolicy: Never
      serviceAccountName: {{ .Release.Name }}-peerpods-installer
      containers:
      - name: install-resourcectrl
        image: bitnami/kubectl:latest
        imagePullPolicy: IfNotPresent
        command:
        - /bin/sh
        - -c
        - |
          set -ex

          # Webhook requires cert-manager - check if it's available
          if kubectl get crd certificates.cert-manager.io >/dev/null 2>&1; then
            echo "Installing PeerPods webhook (cert-manager detected)..."
            kubectl apply -k "github.com/confidential-containers/cloud-api-adaptor//src/webhook/config/default?ref={{ .Values.resourceCtrl.gitRef }}"
          else
            echo "Skipping webhook installation (cert-manager not found)"
          fi

          echo "Webhook installed successfully"
        resources:
          limits:
            cpu: 500m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi
{{- end }}
